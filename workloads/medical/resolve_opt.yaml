datasets:
  transcripts:
    path: /Users/shreyashankar/Documents/hacking/motion-v3/workloads/medical/raw_with_id.json
    type: file
default_model: gpt-4o-mini
operations:
  explode_medications:
    explode_key: medication
    name: explode_medications
    type: explode
  extract_medications:
    name: extract_medications
    optimize: false
    output:
      schema:
        medication: list[str]
    prompt: 'Analyze the following transcript of a conversation between a doctor and
      a patient:


      {{ input.src }}


      Extract and list all medications mentioned in the transcript.

      If no medications are mentioned, return an empty list.

      '
    type: map
  resolve_medications:
    blocking_keys:
    - medication
    blocking_threshold: 0.5758
    comparison_prompt: 'Compare the following two medication entries:

      Entry 1: {{ input1.medication }}

      Entry 2: {{ input2.medication }}


      Are these medications likely to be the same or closely related?

      '
    embedding_model: text-embedding-3-small
    output:
      schema:
        medication: str
    resolution_prompt: 'Given the following matched medication entries:

      {% for entry in matched_entries %}

      Entry {{ loop.index }}: {{ entry.medication }}

      {% endfor %}


      Determine the best resolved medication name for this group of entries. The resolved
      name should be a standardized, widely recognized medication name that best represents
      all matched entries.

      '
    type: resolve
pipeline:
  output:
    path: extracted_medical_info.json
    type: file
  steps:
  - input: transcripts
    name: medical_info_extraction
    operations:
    - extract_medications
    - explode_medications
    - resolve_medications
